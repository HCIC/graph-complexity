<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.5.0/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>

<div class="col-sm-8 col-sm-offset-2">
<div id="graphs"> </div>
<div id="columns"></div>
</div>

<script>
var defaultProperties = {
    "width": 400,
    "height": 400,
    "vertexRadius": 10,
    "edgeWidth": 2,
    "vertexColor": "black",
    "edgeColor": "black",
    "backgroundColor": "white",
    "borderColor": "black",
    "borderWidth": 2,

    "repelStrength": -70,
    "linkDistance": 30,
    "gravityStrength": 0.04,
}

var columns = {
    "screenWidth": screen.width,
    "screenHeight": screen.height,
    "screenAvailableWidth": screen.availWidth,
    "screenAvailableHeight": screen.availHeight,
    "devicePixelRatio": window.devicePixelRatio,
};
_.merge(columns, detectBrowser());

var graphs = [
    {
        "graph":gilbert(_.random(1, 20), Math.random() * 0.5),
    },
    {
        "graph":newman(_.random(1, 20), function() { return _.random(1, 4); }),
    },
    {
        "graph":gilbert(_.random(10, 20), 0.15),
    },
    {
        "graph":newman(_.random(1, 20), function() { return _.random(1, 4); }),
    },
    {
        "graph":gilbert(d3.randomUniform(1, 10)(), 0.3),
    },
];

for( var g = 0; g < graphs.length; g++) {
    var properties = {};
    _.merge(properties, defaultProperties, graphs[g]);

    var graph = properties.graph;
    layoutGraph(properties, graph);

    var container = d3.select("#graphs").append("div")
    drawGraph(properties, graph, container);
    container.append("br")
    addSlider(properties, "graph"+g+"_complexity", "simple", "complex", container)
    addSlider(properties, "graph"+g+"_beauty", "ugly", "beautiful", container)
    container.style("margin-bottom", "100px")

    addGraphToColumns(columns, properties, "graph"+g+"_", graph);
}

generateHiddenInputs(columns, d3.select("#columns"));


////////////////////////////////////////////////

function addGraphToColumns(columns, p, prefix, graph) {
    p["graph"] = GML(p.graph);
    var prefixed = _.mapKeys(p, function(v,k) {return prefix + k;});
    _.merge(columns, prefixed);
}

function drawGraph(p, graph, container) {
    var svg = container.append("svg")
        .attr("width", p.width)
        .attr("height", p.height)
        .style("background-color", p.backgroundColor)
        .style("border", p.borderWidth + "px solid " + p.borderColor);

    svg.append("g").selectAll("line").data(graph.edges).enter()
        .append("line")
        .attr("x1", function(d) { return d.source.x; })
        .attr("y1", function(d) { return d.source.y; })
        .attr("x2", function(d) { return d.target.x; })
        .attr("y2", function(d) { return d.target.y; })
        .attr("stroke", p.edgeColor)
        .attr("stroke-width", p.edgeWidth);

    svg.append("g").selectAll("circle").data(graph.vertices).enter()
        .append("circle")
        .attr("r", p.vertexRadius)
        .attr("cx", function(d) { return d.x; })
        .attr("cy", function(d) { return d.y; })
        .attr("fill", p.vertexColor)
}

function addSlider(p, name, lowLabel, highLabel, container) {
    var slider = container.append("input").attr("type", "range")
        .attr("name", name)
        .attr("min", 0)
        .attr("max", 1)
        .attr("step", 0.0001)
        .attr("value", 0.5)
        .style("width", p.width+"px")
        .style("margin-top", "20px")

    var labels = container.append("div")
        .style("display", "flex")
        .style("justify-content", "space-between")
        .style("width", p.width+"px")

    labels.append("div").text(lowLabel)
    labels.append("div").text(highLabel)
}

function layoutGraph(p, graph) {
    var simulation = d3.forceSimulation()
        .force("center", d3.forceCenter(p.width / 2, p.height / 2))
        .force("gravityx", d3.forceX(p.width / 2).strength(p.gravityStrength))
        .force("gravityy", d3.forceY(p.height / 2).strength(p.gravityStrength))
        .force("repel", d3.forceManyBody().strength(p.repelStrength))
        .force("link", d3.forceLink().id(function(d) { return d.id; }).distance(p.linkDistance))
        .force("collide", d3.forceCollide(p.vertexRadius));

    simulation.nodes(graph.vertices);
    simulation.force("link").links(graph.edges);
    simulation.stop();

    simulation.force("repel").strength(-10000);
    converge()
    converge()
    simulation.force("repel").strength(p.repelStrength);
    converge()
    converge()

    function converge() {
        simulation.alpha(1);
        while (simulation.alpha() >= simulation.alphaMin()) {
            simulation.tick();
        }
    }
}

function addLabValuesForColors(p) {
    StringEndsWithPolyfill();
    for( key in p ) {
        if(key.endsWith("color") || key.endsWith("Color")) {
            var colorLab = d3.lab(p[key]);
            p[key + "LabL"] = colorLab.l;
            p[key + "LabA"] = colorLab.a;
            p[key + "LabB"] = colorLab.b;
        }
    }
}

function generateHiddenInputs(p, inputSelection) {
    addLabValuesForColors(p)

    // convert parameters to array to generate input fields with d3
    var pdata = _.map(p, function(v, k) {
        var obj = { "name": k, "value": v };
        return obj;
    });

    inputSelection.selectAll("input").data(pdata).enter()
        .append("input")
        .attr("type", "hidden")
        .attr("name", function(d) { return d.name; })
        .attr("value", function(d) { return d.value; });
}

function gilbert(n, p) {
    var v = [];
    for (var i = 0; i < n; i++) {
        v.push({ "id": i });
    }
    var e = [];
    for (var i = 0; i < v.length; i++) {
        for (var j = i + 1; j < v.length; j++) {
            if (Math.random() <= p) {
                e.push({ "source": i, "target": j });
            }
        }
    }
    return { "vertices": v, "edges": e };
}

function randomIndex(n) {
    return _.random(0, n - 1);
}

function randomElement(arr) {
    return arr[randomIndex(arr.length)];
}

function newman(n, degp) {
    var vertices = _.times(n, function(i) {
        return { "id": i, "openstubs": degp(), };
    });
    while (_.sumBy(vertices, 'openstubs') % 2 == 1) {
        vertices[randomIndex(n)].openstubs = degp();
    }
    var edgeCount = _.sumBy(vertices, 'openstubs') / 2;
    var edges = [];
    for (var i = 0; i < edgeCount; i++) {
        var candidates = _.filter(vertices, function(v) {
            return v.openstubs > 0;
        });
        if (candidates.length == 1) {
            //TODO:
            console.warn("cannot create more edges. Only one vertex left", candidates);
            break;
        }
        var source = randomElement(candidates);
        var target;
        do {
            target = randomElement(candidates);
        } while (target.id == source.id);
        source.openstubs -= 1;
        target.openstubs -= 1;
        edges.push({ "source": source.id, "target": target.id, });
    }
    // remove openstubs fields
    vertices = _.map(vertices, function(v) {
        return { "id": v.id };
    })
    return { "vertices": vertices, "edges": edges, };
}

function GML(graph) {
    // http://www.fim.uni-passau.de/fileadmin/files/lehrstuhl/brandenburg/projekte/gml/gml-technical-report.pdf
    var nodes = _(graph.vertices).map(function(v) {
        return "node [id " + v.id + " x " + v.x + " y " + v.y + "]";
    }).join(" ");
    var edges = _(graph.edges).map(function(e) {
        return "edge [source " + e.source.id + " target " + e.target.id + "]";
    }).join(" ");
    return "graph [" + nodes + " " + edges + "]";
}

function detectBrowser() {
    var nVer = navigator.appVersion;
    var nAgt = navigator.userAgent;
    var browserName = navigator.appName;
    var fullVersion = '' + parseFloat(navigator.appVersion);
    var majorVersion = parseInt(navigator.appVersion, 10);
    var nameOffset, verOffset, ix;

    // In Opera, the true version is after "Opera" or after "Version"
    if ((verOffset = nAgt.indexOf("Opera")) != -1) {
        browserName = "Opera";
        fullVersion = nAgt.substring(verOffset + 6);
        if ((verOffset = nAgt.indexOf("Version")) != -1)
            fullVersion = nAgt.substring(verOffset + 8);
    }
    // In MSIE, the true version is after "MSIE" in userAgent
    else if ((verOffset = nAgt.indexOf("MSIE")) != -1) {
        browserName = "Microsoft Internet Explorer";
        fullVersion = nAgt.substring(verOffset + 5);
    }
    // In Chrome, the true version is after "Chrome"
    else if ((verOffset = nAgt.indexOf("Chrome")) != -1) {
        browserName = "Chrome";
        fullVersion = nAgt.substring(verOffset + 7);
    }
    // In Safari, the true version is after "Safari" or after "Version"
    else if ((verOffset = nAgt.indexOf("Safari")) != -1) {
        browserName = "Safari";
        fullVersion = nAgt.substring(verOffset + 7);
        if ((verOffset = nAgt.indexOf("Version")) != -1)
            fullVersion = nAgt.substring(verOffset + 8);
    }
    // In Firefox, the true version is after "Firefox"
    else if ((verOffset = nAgt.indexOf("Firefox")) != -1) {
        browserName = "Firefox";
        fullVersion = nAgt.substring(verOffset + 8);
    }
    // In most other browsers, "name/version" is at the end of userAgent
    else if ((nameOffset = nAgt.lastIndexOf(' ') + 1) <
        (verOffset = nAgt.lastIndexOf('/'))) {
        browserName = nAgt.substring(nameOffset, verOffset);
        fullVersion = nAgt.substring(verOffset + 1);
        if (browserName.toLowerCase() == browserName.toUpperCase()) {
            browserName = navigator.appName;
        }
    }
    // trim the fullVersion string at semicolon/space if present
    if ((ix = fullVersion.indexOf(";")) != -1)
        fullVersion = fullVersion.substring(0, ix);
    if ((ix = fullVersion.indexOf(" ")) != -1)
        fullVersion = fullVersion.substring(0, ix);

    majorVersion = parseInt('' + fullVersion, 10);
    if (isNaN(majorVersion)) {
        fullVersion = '' + parseFloat(navigator.appVersion);
        majorVersion = parseInt(navigator.appVersion, 10);
    }

    return {
        "browser": browserName,
        "browser_majorversion": majorVersion,
        "browser_fullversion": fullVersion
    };
}

function StringEndsWithPolyfill() {
    if (!String.prototype.endsWith) {
        String.prototype.endsWith = function(searchString, position) {
            var subjectString = this.toString();
            if (typeof position !== 'number' || !isFinite(position) || Math.floor(position) !== position || position > subjectString.length) {
                position = subjectString.length;
            }
            position -= searchString.length;
            var lastIndex = subjectString.lastIndexOf(searchString, position);
            return lastIndex !== -1 && lastIndex === position;
        };
    }
}
</script>

<style type="text/css">
    /* http://danielstern.ca/range.css/#/ */
input[type=range] {
  -webkit-appearance: none;
  width: 100%;
  margin: 13.8px 0;
}
input[type=range]:focus {
  outline: none;
}
input[type=range]::-webkit-slider-runnable-track {
  width: 100%;
  height: 11.4px;
  cursor: pointer;
  box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
  background: #646464;
  border-radius: 0px;
  border: 0px solid #010101;
}
input[type=range]::-webkit-slider-thumb {
  box-shadow: 0px 0px 0px #000031, 0px 0px 0px #00004b;
  border: 2px solid #00001e;
  height: 39px;
  width: 26px;
  border-radius: 7px;
  background: #ffffff;
  cursor: pointer;
  -webkit-appearance: none;
  margin-top: -13.8px;
}
input[type=range]:focus::-webkit-slider-runnable-track {
  background: #a1a1a1;
}
input[type=range]::-moz-range-track {
  width: 100%;
  height: 11.4px;
  cursor: pointer;
  box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
  background: #646464;
  border-radius: 0px;
  border: 0px solid #010101;
}
input[type=range]::-moz-range-thumb {
  box-shadow: 0px 0px 0px #000031, 0px 0px 0px #00004b;
  border: 2px solid #00001e;
  height: 39px;
  width: 26px;
  border-radius: 7px;
  background: #ffffff;
  cursor: pointer;
}
input[type=range]::-ms-track {
  width: 100%;
  height: 11.4px;
  cursor: pointer;
  background: transparent;
  border-color: transparent;
  color: transparent;
}
input[type=range]::-ms-fill-lower {
  background: #272727;
  border: 0px solid #010101;
  border-radius: 0px;
  box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
}
input[type=range]::-ms-fill-upper {
  background: #646464;
  border: 0px solid #010101;
  border-radius: 0px;
  box-shadow: 0px 0px 0px #000000, 0px 0px 0px #0d0d0d;
}
input[type=range]::-ms-thumb {
  box-shadow: 0px 0px 0px #000031, 0px 0px 0px #00004b;
  border: 2px solid #00001e;
  height: 39px;
  width: 26px;
  border-radius: 7px;
  background: #ffffff;
  cursor: pointer;
  height: 11.4px;
}
input[type=range]:focus::-ms-fill-lower {
  background: #646464;
}
input[type=range]:focus::-ms-fill-upper {
  background: #a1a1a1;
}
</style>
